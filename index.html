<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مفاصاحساب‌کن | حساب دقیق و شیک</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: 246 247 249;            /* #f6f7f9 */
      --ink: 20 24 35;              /* near-black */
      --muted: 105 112 125;         /* gray */
      --brand1: 99 102 241;         /* indigo-500 */
      --brand2: 139 92 246;         /* violet-500 */
      --ok: 16 185 129;             /* emerald */
      --warn: 245 158 11;           /* amber */
      --danger: 239 68 68;          /* red */
      --glass: 255 255 255 / .6;    /* glass */
      --shadow: 0 10px 30px rgb(15 23 42 / .12);
      --radius: 20px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Vazirmatn", system-ui, -apple-system, Segoe UI, Roboto, Arial; color:rgb(var(--ink));
      background:
        radial-gradient(1200px 600px at 85% -10%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(1000px 500px at -10% 90%, rgba(139,92,246,.16), transparent 60%),
        rgb(var(--bg));
      display:grid; place-items:center; padding:24px;
    }
    .app{
      width:min(920px, 96vw); backdrop-filter:saturate(140%) blur(16px);
      background:linear-gradient(180deg, rgba(255,255,255,.86), rgba(255,255,255,.66));
      border:1px solid rgba(99,102,241,.08); border-radius:var(--radius); box-shadow:var(--shadow);
      overflow:hidden;
    }
    .header{ padding:28px 28px 10px; position:relative; isolation:isolate; }
    .header h1{margin:0; font-size:28px; letter-spacing:-.2px}
    .header p{margin:8px 0 0; color:rgb(var(--muted)); font-size:14px}

    .grid{display:grid; grid-template-columns:1.1fr 1fr; gap:18px; padding:18px 24px 24px}
    @media (max-width: 860px){ .grid{grid-template-columns:1fr} }

    .card{background:rgba(255,255,255,.72); border:1px solid rgba(15,23,42,.06); border-radius:16px; box-shadow: var(--shadow); padding:18px}

    .field{display:flex; flex-direction:column; gap:8px; margin:12px 0}
    .label{font-size:13px; color:rgb(var(--muted))}

    .input{ display:flex; align-items:center; gap:10px; border:1px solid rgba(15,23,42,.08); background:white; border-radius:14px; padding:12px 14px; transition:border .2s, box-shadow .2s; box-shadow:inset 0 1px 0 rgba(255,255,255,.6); }
    .input:focus-within{border-color:rgb(var(--brand1)); box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    .input input{all:unset; direction:ltr; flex:1; font-feature-settings:"tnum" 1; font-variant-numeric:tabular-nums;}
    .unit{color:rgb(var(--muted)); font-size:13px}

    .seg{display:flex; gap:8px}
    .chip{appearance:none; border:1px solid rgba(15,23,42,.12); background:white; color:rgb(var(--ink)); border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:700; letter-spacing:.2px; box-shadow:0 2px 8px rgba(0,0,0,.06); transition:all .15s ease}
    .chip:hover{transform:translateY(-1px)}
    .chip.selected{background:linear-gradient(135deg, rgb(var(--brand1)), rgb(var(--brand2))); color:#fff; border-color:transparent; box-shadow:0 8px 18px rgba(99,102,241,.35)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{ appearance:none; border:0; border-radius:14px; padding:12px 16px; cursor:pointer; font-weight:800; letter-spacing:.3px; font-family:"Vazirmatn", system-ui; transition:transform .05s ease, box-shadow .2s ease, background .2s ease; }
    .btn-primary{background:linear-gradient(135deg, rgb(var(--brand1)), rgb(var(--brand2))); color:white; box-shadow:0 10px 24px rgba(99,102,241,.35)}
    .btn-primary:hover{filter:brightness(1.04)}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{background:white; color:rgb(var(--brand1)); border:1px solid rgba(99,102,241,.25)}
    .btn-ghost:hover{background:rgba(99,102,241,.05)}

    .result{ display:grid; gap:10px; align-content:start; }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; background:white; border:1px dashed rgba(15,23,42,.08); border-radius:14px}
    .row .k{color:rgb(var(--muted)); font-size:13px}
    .row .v{font-weight:700; font-size:18px}

    /* Payable highlight */
    .paycard{position:relative; padding:18px; border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85)); overflow:hidden; border:1px solid rgba(99,102,241,.25); box-shadow:0 20px 50px rgba(99,102,241,.25)}
    .paycard::before{content:""; position:absolute; inset:-2px; border-radius:18px; padding:1px; background:linear-gradient(135deg, rgba(99,102,241,.8), rgba(139,92,246,.6), rgba(16,185,129,.6)); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude;}
    .pay-top{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
    .pay-top .k{font-size:13px; color:rgb(var(--muted))}
    .pay-amt{font-size:30px; font-weight:900; letter-spacing:.2px}
    .copy-mini{appearance:none; border:1px solid rgba(15,23,42,.12); background:white; border-radius:12px; padding:8px 10px; font-weight:700; cursor:pointer}

    .badge{display:inline-flex; align-items:center; gap:8px; font-size:12px; color:white; background:linear-gradient(135deg, rgba(16,185,129,.95), rgba(99,102,241,.95)); padding:6px 10px; border-radius:999px}

    .footer{padding:10px 24px 24px; display:flex; justify-content:space-between; gap:10px; align-items:center; color:rgb(var(--muted)); font-size:12px}
    .switch{display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none}
    .switch input{display:none}
    .pill{width:48px; height:26px; background:#e9e9ee; border-radius:999px; position:relative; transition:background .2s}
    .pill::after{content:""; position:absolute; width:20px; height:20px; top:3px; right:3px; border-radius:50%; background:white; box-shadow:0 2px 6px rgba(0,0,0,.15); transition:transform .2s}
    .switch input:checked + .pill{background:rgba(16,185,129,.4)}
    .switch input:checked + .pill::after{transform:translateX(-22px)}

    @media (prefers-color-scheme: dark){
      :root{ --bg: 13 16 24; --ink: 241 245 249; --muted: 148 163 184 }
      body{background:
        radial-gradient(1000px 500px at 100% -10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 600px at -20% 100%, rgba(139,92,246,.2), transparent 60%),
        rgb(var(--bg));}
      .app{background:linear-gradient(180deg, rgba(15,23,42,.66), rgba(15,23,42,.5)); border-color:rgba(99,102,241,.15)}
      .card{background:rgba(15,23,42,.6); border-color:rgba(255,255,255,.07)}
      .input{background:rgba(0,0,0,.3); border-color:rgba(255,255,255,.08)}
      .row{background:rgba(0,0,0,.2); border-color:rgba(255,255,255,.09)}
      .btn-ghost{background:transparent; color:white; border-color:rgba(148,163,184,.35)}
      .paycard{background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.7)); border-color:rgba(99,102,241,.35)}
      .copy-mini{background:rgba(0,0,0,.2); color:white; border-color:rgba(255,255,255,.12)}
    }
  </style>
</head>
<body>
  <main class="app" id="app">
    <section class="header">
      <h1>مفاصاحساب‌کن ✨</h1>
    </section>

    <section class="grid">
      <!-- Inputs -->
      <div class="card">
        <div class="field">
          <div class="label">درصد مفاصا</div>
          <div class="seg" role="radiogroup" aria-label="انتخاب درصد مفاصا">
            <button class="chip selected" data-percent="7.8" role="radio" aria-checked="true">7.8٪</button>
            <button class="chip" data-percent="16.67" role="radio" aria-checked="false">16.67٪</button>
          </div>
        </div>
        <div class="field">
          <div class="label">مبلغ مبنا (قبل از تخفیف)</div>
          <input id="base" class="input" placeholder="مثلاً 173,860,000" inputmode="numeric" />
        </div>
        <div class="actions">
          <button class="btn-primary" id="calcBtn">محاسبه</button>
          <button class="btn-ghost" id="resetBtn">ریست</button>
        </div>
      </div>

      <!-- Results -->
      <div class="card result" aria-live="polite" aria-atomic="true">
        <div class="row">
          <div class="k">مبلغ کسر مفاصا</div>
          <div class="v" id="deduct">—</div>
        </div>
        <div class="paycard" id="payCard">
          <div class="pay-top">
            <div class="k">مبلغ قابل پرداخت (نهایی)</div>
            <button class="copy-mini" id="copyPayable">کپی مبلغ</button>
          </div>
          <div class="pay-amt" id="payable">—</div>
        </div>
        <div class="row">
          <div class="k">مبنای محاسبه (ورودی)</div>
          <div class="v" id="baseEcho">—</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Utilities ----------
    const $ = (q) => document.querySelector(q);

    const persianDigitMap = {
      '۰': '0','۱': '1','۲': '2','۳': '3','۴': '4','۵': '5','۶': '6','۷': '7','۸': '8','۹': '9',
      '٬': ',', // Arabic thousands separator
    };

    function normalizeNumber(str){
      if (!str) return 0;
      str = String(str).trim();
      // Convert Persian/Arabic digits to Latin
      str = str.replace(/[۰-۹٬]/g, ch => persianDigitMap[ch] ?? ch);
      // Keep digits and decimal point only, remove commas
      str = str.replace(/,/g, '').replace(/[^0-9.]/g, '');
      const val = parseFloat(str);
      return isFinite(val) ? val : 0;
    }

    function formatMoney(value, fa=true){
      try{
        const fmt = new Intl.NumberFormat(fa ? 'fa-IR' : 'en-US');
        return fmt.format(Math.round(value));
      }catch(e){ return String(Math.round(value)); }
    }

    function formatPercent(value, fa=true){
      const fmt = new Intl.NumberFormat(fa ? 'fa-IR' : 'en-US', { maximumFractionDigits: 4 });
      return fmt.format(value);
    }

    function formatInputWithGrouping(el){
      const fa = $('#faDigits').checked;
      const raw = normalizeNumber(el.value);
      el.value = raw ? formatMoney(raw, fa) : '';
    }

    // ---------- Core Logic ----------
    function selectedPercent(){
      const sel = document.querySelector('.chip.selected');
      return sel ? parseFloat(sel.dataset.percent) : 7.8;
    }

    function compute(){
      const fa = $('#faDigits').checked;
      const percent = selectedPercent();
      const base = normalizeNumber($('#base').value);
      const deduct = base * (percent / 100);
      const payable = base - deduct;

      $('#deduct').textContent = base ? `${formatMoney(deduct, fa)} تومان` : '—';
      $('#payable').textContent = base ? `${formatMoney(payable, fa)} تومان` : '—';
      $('#baseEcho').textContent = base ? `${formatMoney(base, fa)} تومان` : '—';

      const card = $('#payCard');
      card.style.borderColor = base ? 'rgba(99,102,241,.45)' : 'rgba(15,23,42,.08)';
    }

    // ---------- Events ----------
    document.querySelectorAll('.chip').forEach(ch => {
      ch.addEventListener('click', () => {
        document.querySelectorAll('.chip').forEach(c => { c.classList.remove('selected'); c.setAttribute('aria-checked','false'); });
        ch.classList.add('selected');
        ch.setAttribute('aria-checked','true');
        compute();
      });
    });

    ['#base'].forEach(sel => {
      $(sel).addEventListener('input', () => { formatInputWithGrouping($(sel)); compute(); });
      $(sel).addEventListener('change', () => { formatInputWithGrouping($(sel)); compute(); });
    });

    $('#calcBtn')?.addEventListener('click', (e)=>{ e.preventDefault(); compute(); });
    $('#resetBtn')?.addEventListener('click', (e)=>{
      e.preventDefault();
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      document.querySelector('.chip[data-percent="7.8"]').classList.add('selected');
      $('#base').value = '';
      ['#deduct','#payable','#baseEcho'].forEach(sel => $(sel).textContent = '—');
    });

    $('#copyBtn')?.addEventListener('click', async (e)=>{
      e.preventDefault();
      const txt = `
نتایج محاسبه مفاصا
————————————
درصد مفاصا: ${formatPercent(selectedPercent(), $('#faDigits').checked)}٪
مبلغ مبنا: ${formatMoney(normalizeNumber($('#base').value), $('#faDigits').checked)} تومان
مبلغ کسر: ${$('#deduct').textContent}
مبلغ قابل پرداخت: ${$('#payable').textContent}
`;
      try{ await navigator.clipboard.writeText(txt); e.target.textContent = 'کپی شد!'; setTimeout(()=> e.target.textContent = 'کپی نتایج', 1500);}catch(err){ alert('کپی در کلیپ‌بورد انجام نشد.'); }
    });

    $('#copyPayable')?.addEventListener('click', async (e)=>{
      const payTxt = $('#payable').textContent.replace(/\s*تومان\s*$/, '');
      try{ await navigator.clipboard.writeText(payTxt); e.target.textContent = 'کپی شد!'; setTimeout(()=> e.target.textContent = 'کپی مبلغ', 1500);}catch(err){ alert('کپی انجام نشد'); }
    });

    $('#faDigits').addEventListener('change', ()=>{ formatInputWithGrouping($('#base')); compute(); });

    // Prefill sample and compute once
    window.addEventListener('DOMContentLoaded', ()=>{
      document.querySelector('.chip[data-percent="7.8"]').classList.add('selected');
      $('#base').value = '173,860,000';
      formatInputWithGrouping($('#base'));
      compute();
    });
  </script>
</body>
</html>
